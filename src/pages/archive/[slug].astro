---
import ArchiveLayout from '~/layouts/archiveLayout.astro';

export async function getStaticPaths() {
    const STRAPI_URL = 'https://strapi-app-63132904920.asia-northeast3.run.app';

    try {
        const response = await fetch(`${STRAPI_URL}/api/resources?populate[actors][fields][0]=name&populate[attachments][fields][0]=url&populate[attachments][fields][1]=name&populate[summary_content]`);
        if (!response.ok) {
            console.error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            return [];
        }
        const data = await response.json();
        const resources = data.data || [];

        console.log('ğŸ” APIì—ì„œ ê°€ì ¸ì˜¨ ë¦¬ì†ŒìŠ¤ ê°œìˆ˜:', resources.length);
        console.log('ğŸ” ë¦¬ì†ŒìŠ¤ documentId ëª©ë¡:', resources.map(r => r.documentId));

        if (resources.length === 0) {
            console.warn('âš ï¸ APIì—ì„œ ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return [];
        }

        const staticPaths = resources.map(resource => ({
            params: { slug: String(resource.documentId) },
            props: { resource }
        }));

        console.log('ğŸ” ìµœì¢… ìƒì„±ëœ ê²½ë¡œ ê°œìˆ˜:', staticPaths.length);
        console.log('ğŸ” ìƒì„±ëœ ëª¨ë“  slug:', staticPaths.map(r => r.params.slug));

        return staticPaths;

    } catch (error) {
        console.error("getStaticPaths í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
        return [];
    }
}

const STRAPI_URL = 'https://strapi-app-63132904920.asia-northeast3.run.app';
const { resource } = Astro.props;

if (!resource) {
    return Astro.redirect('/404');
}

const firstParagraph = resource.summary_content?.[0]?.children?.[0]?.text;
const description = firstParagraph ? firstParagraph.substring(0, 150) + '...' : resource.title;

const attachmentUrl = resource.attachments?.[0]?.url;

const resourceTypeMap = {
    'document': 'ë¬¸ì„œ',
    'statement': 'ì„±ëª…ì„œ',
    'press-release': 'ë³´ë„ìë£Œ',
    'report': 'ë³´ê³ ì„œ',
    'photo': 'ì‚¬ì§„',
    'video': 'ì˜ìƒ',
    'etc': 'ê¸°íƒ€',
};

const translatedResourceType = resourceTypeMap[resource.resource_type] || resource.resource_type;

// Rich Textë¥¼ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ê°œì„ )
function convertRichTextToHTML(richTextArray) {
    if (!richTextArray || !Array.isArray(richTextArray)) {
        return '';
    }

    return richTextArray.map(block => {
        let blockContent = '';
        if (block.children) {
            const childrenHtml = block.children.map(child => {
                let text = child.text || '';
                // êµµê²Œ, ê¸°ìš¸ì„ê¼´ ë“± ì„œì‹ ì ìš©
                if (child.bold) text = `<strong>${text}</strong>`;
                if (child.italic) text = `<em>${text}</em>`;
                if (child.underline) text = `<u>${text}</u>`;
                if (child.strikethrough) text = `<s>${text}</s>`;

                // ë§í¬ ì„œì‹ ì ìš©
                if (child.type === 'link') {
                    // target ì†ì„± ì¶”ê°€
                    return `<a href="${child.url}" target="_blank" rel="noopener noreferrer">${child.children[0].text}</a>`;
                }

                return text;
            }).join('');
            blockContent = childrenHtml;
        }

        // ë¸”ë¡ íƒ€ì…ì— ë”°ë¼ HTML íƒœê·¸ ìƒì„±
        if (block.type === 'paragraph') {
            if (blockContent.trim() === '') {
                return '<br>';
            }
            return `<p>${blockContent}</p>`;
        }
        if (block.type === 'list') {
            if (block.format === 'ordered') {
                const listItems = block.children.map(item => `<li>${convertRichTextToHTML(item.children)}</li>`).join('');
                return `<ol>${listItems}</ol>`;
            }
            const listItems = block.children.map(item => `<li>${convertRichTextToHTML(item.children)}</li>`).join('');
            return `<ul>${listItems}</ul>`;
        }
        if (block.type === 'heading') {
            return `<h${block.level}>${blockContent}</h${block.level}>`;
        }

        return blockContent;
    }).join('');
}

// getStaticPathsì—ì„œ summary_contentë¥¼ populateí•˜ì§€ ì•Šì•„ ì—¬ê¸°ì„œ ì¬í˜¸ì¶œ
// ì´ ë°©ë²•ì€ ë¹„íš¨ìœ¨ì ì´ë¯€ë¡œ, ê°€ëŠ¥í•˜ë©´ getStaticPathsì—ì„œ í•œë²ˆì— ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
// (getStaticPaths ì¿¼ë¦¬ì— populate[summary_content]ë¥¼ ì¶”ê°€í•˜ë©´ ì´ ë¶€ë¶„ì€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.)
const fullResourceResponse = await fetch(`${STRAPI_URL}/api/resources/${resource.id}?populate=summary_content`);
const fullResourceData = await fullResourceResponse.json();
const fullContentArray = fullResourceData.data.attributes.summary_content;

const fullContent = convertRichTextToHTML(fullContentArray);

let finalUrl = null;
let buttonText = 'ë§í¬ ì—†ìŒ';

let isSourceBroken = false;
if (resource.source_url) {
    try {
        const urlResponse = await fetch(resource.source_url, { method: 'HEAD', timeout: 5000 });
        isSourceBroken = !urlResponse.ok;
    } catch (e) {
        isSourceBroken = true;
    }
}

if (resource.source_url && !isSourceBroken) {
    finalUrl = resource.source_url;
    buttonText = 'ì›ë¬¸ í˜ì´ì§€ë¡œ ì´ë™';
}
else if (attachmentUrl) {
    finalUrl = attachmentUrl;
    buttonText = 'ìë£Œ ë‹¤ìš´ë¡œë“œ';
    if (resource.copyright_status === 'KOGL' || resource.copyright_status === 'copyrighted') {
        buttonText += ' (ë°±ì—…)';
    }
}
else {
    finalUrl = null;
    buttonText = 'ë§í¬ ì—†ìŒ';
}
---
<ArchiveLayout title={resource.title} description={description}>
    <div class="archive-main-content">
        <header class="resource-header">
            <h1 class="resource-title">{resource.title}</h1>
            <p class="resource-date">ì›ë³¸ì‘ì„±ì¼: {resource.date}</p>
        </header>

        <aside class="metadata-sidebar">
            <div class="metadata-item">
                <strong>ìë£Œ ìœ í˜•</strong>
                <span>{translatedResourceType}</span>
            </div>
            {resource.actors?.length > 0 && (
                    <div class="metadata-item">
                        <strong>ì‘ì„±ì/ì œê³µê¸°ê´€</strong>
                        <span>
                        {resource.actors.map(actor => actor.name).join(', ')}
                    </span>
                    </div>
            )}
            <div class="metadata-item">
                <strong>ì €ì‘ê¶Œ ìƒíƒœ</strong>
                <span>{resource.copyright_status}</span>
            </div>
            {resource.copyright_specific && (
                    <div class="metadata-item">
                        <strong>ì„¸ë¶€ ë¼ì´ì„ ìŠ¤</strong>
                        <span>{resource.copyright_specific}</span>
                    </div>
            )}

            <div class="action-buttons">
                {finalUrl ? (
                        <a href={finalUrl} class="button-primary" target="_blank" rel="noopener noreferrer">{buttonText}</a>
                ) : (
                        <span class="no-link-message">ë§í¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
                )}
            </div>
        </aside>

        <main class="resource-body">
            <div class="content-text-block">
                <div set:html={fullContent}></div>
            </div>
        </main>
    </div>
</ArchiveLayout>

<style>
    .archive-main-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        max-width: 800px; /* max-widthë¥¼ 1000pxë¡œ ë³€ê²½ */
        margin: 0 auto;
        padding: 0 1rem;
        /* ëª¨ë°”ì¼ ìš°ì„ : ì‚¬ì´ë“œë°”ê°€ ë³¸ë¬¸ ìœ„ì— ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì • */
        grid-template-areas:
                "header"
                "sidebar"
                "body";
    }

    .resource-header {
        grid-area: header; /* ê·¸ë¦¬ë“œ ì˜ì—­ ì§€ì • */
        margin-top: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .resource-body {
        grid-area: body; /* ê·¸ë¦¬ë“œ ì˜ì—­ ì§€ì • */
    }

    .metadata-sidebar {
        grid-area: sidebar; /* ê·¸ë¦¬ë“œ ì˜ì—­ ì§€ì • */
    }

    .resource-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        line-height: 1.3;
    }

    .resource-date {
        font-size: 0.9rem;
        color: #666;
        margin: 0;
    }

    .metadata-item {
        margin-bottom: 1rem;
    }

    .metadata-item strong {
        display: block;
        font-size: 0.9rem;
        color: #444;
        margin-bottom: 0.25rem;
    }

    .metadata-item span {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .action-buttons {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #f0f0f0;
    }

    .button-primary {
        display: block;
        padding: 0.75rem 1.5rem;
        background-color: #355E3B;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        font-weight: 600;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
        transition: background-color 0.2s ease;
    }

    .button-primary:hover {
        background-color: #2a4a2f;
    }

    .content-text-block {
        line-height: 1.7;
    }

    .content-text-block p {
        margin-bottom: 1rem;
    }

    .no-link-message {
        color: #888;
        font-style: italic;
        font-size: 0.9rem;
        display: block;
        text-align: center;
        padding: 0.75rem;
    }

    /* ë°ìŠ¤í¬í†±: 2ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ */
    @media (min-width: 768px) {
        .archive-main-content {
            grid-template-columns: 2fr 1fr;
            grid-template-areas:
                "header header"
                "body sidebar";
            gap: 2rem;
        }

        .metadata-sidebar {
            border-left: 1px solid #e0e0e0;
            padding-left: 2rem;
            position: sticky;
            top: 2rem;
            height: fit-content;
        }
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    @media (max-width: 480px) {
        .archive-main-content {
            padding: 0 1rem;
        }

        .resource-title {
            font-size: 1.5rem;
        }
    }
</style>