---
import ArchiveLayout from '~/layouts/archiveLayout.astro';

export async function getStaticPaths() {
    const STRAPI_URL = 'https://strapi-app-63132904920.asia-northeast3.run.app';

    try {
        const response = await fetch(`${STRAPI_URL}/api/resources?populate[actors][fields][0]=name&populate[attachments][fields][0]=url&populate[attachments][fields][1]=name&populate[archive_collections][fields][0]=title&populate[archive_collections][fields][1]=slug`);
        if (!response.ok) {
            console.error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            return [];
        }
        const data = await response.json();
        const resources = data.data || [];

        // console.log('ğŸ” APIì—ì„œ ê°€ì ¸ì˜¨ ë¦¬ì†ŒìŠ¤ ê°œìˆ˜:', resources.length);
        // console.log('ğŸ” ë¦¬ì†ŒìŠ¤ documentId ëª©ë¡:', resources.map(r => r.documentId));

        if (resources.length === 0) {
            console.warn('âš ï¸ APIì—ì„œ ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return [];
        }

        const staticPaths = resources.map(resource => ({
            params: { slug: String(resource.documentId) },
            props: { resource }
        }));

        // console.log('ğŸ” ìµœì¢… ìƒì„±ëœ ê²½ë¡œ ê°œìˆ˜:', staticPaths.length);
        // console.log('ğŸ” ìƒì„±ëœ ëª¨ë“  slug:', staticPaths.map(r => r.params.slug));

        return staticPaths;

    } catch (error) {
        console.error("getStaticPaths í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
        return [];
    }
}

const STRAPI_URL = 'https://strapi-app-63132904920.asia-northeast3.run.app';
const { resource } = Astro.props;

// --- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ ---
// console.log('--- Astro Props Debug ---');
// console.log('Received resource prop:', resource);
// console.log('-------------------------');

if (!resource) {
    return Astro.redirect('/404');
}

const firstParagraph = resource.summary_content?.[0]?.children?.[0]?.text;
const description = firstParagraph ? firstParagraph.substring(0, 150) + '...' : resource.title;

const attachmentUrl = resource.attachments?.[0]?.url;

const resourceTypeMap = {
    'document': 'ë¬¸ì„œ',
    'statement': 'ì„±ëª…ì„œ',
    'press-release': 'ë³´ë„ìë£Œ',
    'report': 'ë³´ê³ ì„œ',
    'photo': 'ì‚¬ì§„',
    'video': 'ì˜ìƒ',
    'etc': 'ê¸°íƒ€',
};

const translatedResourceType = resourceTypeMap[resource.resource_type] || resource.resource_type;

// ë¦¬ì¹˜ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜í•˜ëŠ” ë” êµ¬ì¡°ì ì¸ í•¨ìˆ˜
function convertRichTextToHTML(richTextArray) {
    if (!richTextArray || !Array.isArray(richTextArray)) {
        return '';
    }

    return richTextArray.map(block => {
        switch (block.type) {
            case 'paragraph': {
                const content = block.children.map(child => parseInlineContent(child)).join('');
                return `<p>${content}</p>`;
            }
            case 'list': {
                const listType = block.format === 'ordered' ? 'ol' : 'ul';
                const listItems = block.children.map(item => {
                    const content = item.children.map(child => parseInlineContent(child)).join('');
                    return `<li>${content}</li>`;
                }).join('');
                return `<${listType}>${listItems}</${listType}>`;
            }
            default:
                return ''; // ì •ì˜ë˜ì§€ ì•Šì€ ë¸”ë¡ íƒ€ì… ë¬´ì‹œ
        }
    }).join('');
}

// í…ìŠ¤íŠ¸ì™€ ë§í¬ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë‚´ë¶€ í•¨ìˆ˜
function parseInlineContent(child) {
    // ë§í¬ ì²˜ë¦¬
    if (child.type === 'link') {
        const linkText = child.children.map(linkChild => parseInlineContent(linkChild)).join('') || 'ë§í¬';
        return `<a href="${child.url}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
    }
    // ì¼ë°˜ í…ìŠ¤íŠ¸ ë° ì„œì‹ ì ìš©
    else if (child.text) {
        let text = child.text;
        if (child.bold) text = `<strong>${text}</strong>`;
        if (child.italic) text = `<em>${text}</em>`;
        if (child.underline) text = `<u>${text}</u>`;
        if (child.strikethrough) text = `<s>${text}</s>`;
        return text;
    }
    return '';
}

const fullContent = convertRichTextToHTML(resource.summary_content);

// ë²„íŠ¼ ë¡œì§
let finalUrl = null;
let buttonText = 'ë§í¬ ì—†ìŒ';

// ì›ë¬¸ URLì˜ ìœ íš¨ì„±ì„ ë¨¼ì € ê²€ì‚¬í•©ë‹ˆë‹¤.
import { Agent } from 'undici';

// SSL ì¸ì¦ì„œ ì˜¤ë¥˜ë¥¼ ë¬´ì‹œí•˜ëŠ” Agentë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
const sslAgent = new Agent({
    connect: {
        rejectUnauthorized: false
    }
});

let isSourceBroken = false;
if (resource.source_url) {
    try {
        // ì²« ë²ˆì§¸ ì‹œë„: HEAD ìš”ì²­
        const headResponse = await fetch(resource.source_url, {
            method: 'HEAD',
            timeout: 5000,
            dispatcher: sslAgent
        });
        isSourceBroken = !headResponse.ok;

        // HEAD ìš”ì²­ì´ ì‹¤íŒ¨í•˜ë©´ GET ìš”ì²­ìœ¼ë¡œ ì¬ì‹œë„
        if (isSourceBroken) {
            console.log('HEAD ìš”ì²­ ì‹¤íŒ¨. GET ìš”ì²­ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.');
            const getResponse = await fetch(resource.source_url, {
                method: 'GET',
                timeout: 5000,
                dispatcher: sslAgent
            });
            isSourceBroken = !getResponse.ok;
        }

    } catch (e) {
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“± ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ GET ìš”ì²­ìœ¼ë¡œ ì¬ì‹œë„
        console.log('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ. GET ìš”ì²­ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.');
        try {
            const getResponse = await fetch(resource.source_url, {
                method: 'GET',
                timeout: 5000,
                dispatcher: sslAgent
            });
            isSourceBroken = !getResponse.ok;
        } catch (e) {
            // GET ìš”ì²­ê¹Œì§€ ì‹¤íŒ¨í•˜ë©´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ê°„ì£¼
            console.error('GET ìš”ì²­ê¹Œì§€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', e);
            isSourceBroken = true;
        }
    }
}
// --- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ ---
// console.log('Final URL:', finalUrl, 'Button Text:', buttonText);
// -------------------------


// 1. ì›ë¬¸ URLì´ ìˆê³  ìœ íš¨í•œ ê²½ìš°, ì›ë¬¸ í˜ì´ì§€ë¡œ ì´ë™
if (resource.source_url && !isSourceBroken) {
    finalUrl = resource.source_url;
    buttonText = 'ì›ë¬¸ í˜ì´ì§€ë¡œ ì´ë™';
}
// 2. ì›ë¬¸ URLì´ ì—†ê±°ë‚˜ ê¹¨ì¡Œê³ , ì²¨ë¶€íŒŒì¼ì´ ìˆëŠ” ê²½ìš°, ìë£Œ ë‹¤ìš´ë¡œë“œ
else if (attachmentUrl) {
    finalUrl = attachmentUrl;
    buttonText = 'ìë£Œ ë‹¤ìš´ë¡œë“œ';
    // ì €ì‘ê¶Œ ìƒíƒœê°€ KOGL ë˜ëŠ” copyrightedì´ë©´ì„œ ë°±ì—… ë§í¬ì¸ ê²½ìš°
    if (resource.copyright_status === 'KOGL' || resource.copyright_status === 'copyrighted') {
        buttonText += ' (ë°±ì—…)';
    }
}
// 3. ë‘˜ ë‹¤ ì—†ëŠ” ê²½ìš°
else {
    finalUrl = null;
    buttonText = 'ë§í¬ ì—†ìŒ';
}
---

<ArchiveLayout title={resource.title} description={description}>
    <div class="archive-main-content">
        <header class="resource-header">
            <h1 class="resource-title">{resource.title}</h1>
            <p class="resource-date">ì›ë³¸ì‘ì„±ì¼: {resource.date}</p>
        </header>

        <aside class="metadata-sidebar">
            <div class="metadata-item">
                <strong>ìë£Œ ìœ í˜•</strong>
                <span>{translatedResourceType}</span>
            </div>
            {resource.actors?.length > 0 && (
                    <div class="metadata-item">
                        <strong>ì‘ì„±ì/ì œê³µê¸°ê´€</strong>
                        <span>
                        {resource.actors.map(actor => actor.name).join(', ')}
                    </span>
                    </div>
            )}
            <div class="metadata-item">
                <strong>ì €ì‘ê¶Œ ìƒíƒœ</strong>
                <span>{resource.copyright_status}</span>
            </div>
            {resource.copyright_specific && (
                    <div class="metadata-item">
                        <strong>ì„¸ë¶€ ë¼ì´ì„ ìŠ¤</strong>
                        <span>{resource.copyright_specific}</span>
                    </div>
            )}

            {resource.archive_collections?.length > 0 && (
                    <div class="metadata-item related-collections">
                        <strong>ê´€ë ¨ ì•„ì¹´ì´ë¸Œ ì»¬ë ‰ì…˜</strong>
                        <ul>
                            {resource.archive_collections.map(collection => (
                                    <li>
                                        <a href={`/archive/collection/${collection.slug}`}>
                                            {collection.title}
                                        </a>
                                    </li>
                            ))}
                        </ul>
                    </div>
            )}
            <div class="action-buttons">
                {finalUrl ? (
                        <a href={finalUrl} class="button-primary" target="_blank" rel="noopener noreferrer">{buttonText}</a>
                ) : (
                        <span class="no-link-message">ë§í¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
                )}
            </div>
        </aside>

        <main class="resource-body">
            <div class="content-text-block">
                <div set:html={fullContent}></div>
            </div>
        </main>
    </div>
</ArchiveLayout>

<style>
    .archive-main-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        max-width: 800px;
        margin: 0 auto;
        padding: 0 1rem;
        /* ëª¨ë°”ì¼: í—¤ë” â†’ ì‚¬ì´ë“œë°” â†’ ë³¸ë¬¸ ìˆœì„œ */
        grid-template-areas:
            "header"
            "sidebar"
            "body";
    }

    .resource-header {
        grid-area: header;
        margin-top: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .resource-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        line-height: 1.3;
    }

    .resource-date {
        font-size: 0.9rem;
        color: #666;
        margin: 0;
    }

    .resource-body {
        grid-area: body;
    }

    .metadata-sidebar {
        grid-area: sidebar;
    }

    .metadata-item {
        margin-bottom: 1rem;
    }

    .related-collections ul {
        list-style-type: none;
        padding-left: 0;
        margin-top: 0.5rem;
    }

    .related-collections li {
        margin-bottom: 0.25rem;
    }

    .related-collections a {
        display: block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background-color: #f5f5f5;
        color: #1a1a1a;
        text-decoration: none;
        transition: background-color 0.2s ease;
    }

    .related-collections a:hover {
        background-color: #e0e0e0;
    }


    .metadata-item strong {
        display: block;
        font-size: 0.9rem;
        color: #444;
        margin-bottom: 0.25rem;
    }

    .metadata-item span {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .action-buttons {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #f0f0f0;
    }

    .button-primary {
        display: block;
        padding: 0.75rem 1.5rem;
        background-color: #355E3B;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        font-weight: 600;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
        transition: background-color 0.2s ease;
    }

    .button-primary:hover {
        background-color: #2a4a2f;
    }

    .content-text-block {
        line-height: 1.7;
    }

    .content-text-block p {
        margin-bottom: 1rem;
    }

    /* ë³¸ë¬¸ ë‚´ ë§í¬ ìŠ¤íƒ€ì¼ë§ */
    .content-text-block a {
        color: #355E3B;
        text-decoration: underline;
        font-weight: 500;
        transition: color 0.2s ease;
    }

    .content-text-block a:hover {
        color: #2a4a2f;
        text-decoration-thickness: 2px;
    }

    .no-link-message {
        color: #888;
        font-style: italic;
        font-size: 0.9rem;
        display: block;
        text-align: center;
        padding: 0.75rem;
    }

    /* ë°ìŠ¤í¬í†±: 2ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ */
    @media (min-width: 768px) {
        .archive-main-content {
            grid-template-columns: 2fr 1fr !important;
            grid-template-areas:
                "header header"
                "body sidebar" !important;
            gap: 2rem;
            max-width: 800px;
        }

        .metadata-sidebar {
            border-left: 1px solid #e0e0e0 !important;
            padding-left: 2rem !important;
            position: sticky !important;
            top: 2rem;
            height: fit-content;
            border-bottom: none !important;
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• - ëª…ì‹œì ìœ¼ë¡œ ìˆœì„œ ì¬ì •ì˜ */
    @media (max-width: 767px) {
        .archive-main-content {
            grid-template-areas:
                "header"
                "sidebar"
                "body" !important;
            padding: 0 1rem;
        }

        .resource-title {
            font-size: 1.5rem;
        }

        .metadata-sidebar {
            border-left: none !important;
            padding-left: 0 !important;
            position: static !important;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1.5rem;
            margin-bottom: 1rem;
        }
    }
</style>