---
// src/pages/webzine/[slug].astro

import WebzineLayout from '~/layouts/WebzineLayout.astro';
import Content from '~/components/Content.astro';
import LinkCard from '~/components/LinkCard.astro';
import ListItem from '~/components/ListItem.astro';
import Callout from '~/components/Callout.astro';
import Image from '~/components/Image.astro';

import MarkdownIt from 'markdown-it'; // âœ… MarkdownIt ì„í¬íŠ¸

const components = {
    'common.content': Content,
    'common.link-card': LinkCard,
    'common.list-item': ListItem,
    'common.callout': Callout,
    'common.image': Image,
};

export async function getStaticPaths() {
    const strapiUrl = 'https://strapi-app-63132904920.asia-northeast3.run.app';

    try {
        const metaUrl = `${strapiUrl}/api/webzine-articles?populate[0]=author&populate[1]=featuredImage`;
        const metaResponse = await fetch(metaUrl);
        if (!metaResponse.ok) {
            console.error(`ë©”íƒ€ë°ì´í„° API í˜¸ì¶œ ì‹¤íŒ¨: ${metaResponse.status}`);
            return [];
        }
        const metaData = await metaResponse.json();

        const contentUrl = `${strapiUrl}/api/webzine-articles?populate[content][populate]=*`;
        const contentResponse = await fetch(contentUrl);
        if (!contentResponse.ok) {
            console.error(`ì»¨í…ì¸  API í˜¸ì¶œ ì‹¤íŒ¨: ${contentResponse.status}`);
            return [];
        }
        const contentData = await contentResponse.json();

        const mergedArticles = metaData.data?.map(metaArticle => {
            const contentArticle = contentData.data?.find(c => c.id === metaArticle.id);
            return {
                ...metaArticle,
                content: contentArticle?.content || []
            };
        });

        return mergedArticles?.map((article) => {
            const slug = article?.slug;
            if (slug && typeof slug === 'string') {
                return {
                    params: { slug },
                    props: { article },
                };
            }
            return null;
        }).filter(Boolean) || [];

    } catch (error) {
        console.error("getStaticPaths í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
        return [];
    }
}

const { article } = Astro.props;

if (!article) {
    return Astro.redirect('/404');
}

// --- âœ… meta description ìƒì„± ë¡œì§ ì‹œì‘ ---
const firstContentComponent = article.content?.find(
    (item) => item.__component === 'common.content'
);

let description = '';

if (firstContentComponent && firstContentComponent.content) {
    let plainText = firstContentComponent.content
        .replace(/<[^>]*>/g, '')
        .replace(/\[\^[^\]]+\]/g, '')
        .replace(/\[[^\]]+\]\([^)]+\)/g, '');

    description = plainText.length > 150
        ? `${plainText.substring(0, 150).trim()}...`
        : plainText.trim();
}

// --- âœ… meta description ìƒì„± ë¡œì§ ë ---

// ì´ë¯¸ì§€ URL ì²˜ë¦¬ í•¨ìˆ˜
function getImageUrl(featuredImage) {
    if (!featuredImage) return null;
    const baseUrl = 'https://strapi-app-63132904920.asia-northeast3.run.app';

    let imageUrlPath = featuredImage.formats?.large?.url || featuredImage.formats?.medium?.url || featuredImage.formats?.small?.url || featuredImage.url;

    if (imageUrlPath && !imageUrlPath.startsWith('http')) {
        imageUrlPath = `${baseUrl}${imageUrlPath}`;
    }
    return imageUrlPath;
}

// âœ… MarkdownIt ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ì›¹ì§„ìš©)
const mdForWebzineContent = new MarkdownIt({
    html: true,
    typographer: true,
    linkify: true,
});

// âœ… ì›¹ì§„ ì½˜í…ì¸ ì˜ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function processWebzineContent(contentArray) {
    if (!contentArray || !Array.isArray(contentArray)) return [];

    return contentArray.map(item => {
        if (item.__component === 'common.content' && item.content) {
            // Content ì»´í¬ë„ŒíŠ¸ì˜ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
            const htmlContent = mdForWebzineContent.render(item.content);
            return { ...item, content: htmlContent };
        } else if (item.__component === 'common.list-item' && item.items) {
            const processedItems = item.items.map(listItem => {
                if (listItem && typeof listItem.ListText === 'string') { // ListItemì˜ í•„ë“œëª… í™•ì¸ (ListText)
                    // ListItemì˜ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ (ì¤‘ì²© ë¦¬ìŠ¤íŠ¸ë¥¼ ìœ„í•´ render() ì‚¬ìš©)
                    const htmlListItemText = mdForWebzineContent.render(listItem.ListText);
                    return { ...listItem, ListText: htmlListItemText };
                }
                return listItem;
            });
            return { ...item, items: processedItems };
        }
        // LinkCardì™€ ê°™ì€ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ëŠ” ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ í•„ë“œê°€ ì—†ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë°˜í™˜
        return item;
    });
}

// âœ… article.contentë¥¼ HTMLë¡œ ë¯¸ë¦¬ ë³€í™˜
const processedArticleContent = processWebzineContent(article.content);

---

<WebzineLayout
        title={article.title}
        description={description}
        author={article.author}
        publishedat={article.publishedat}
        featuredImage={article.featuredImage ? {
            url: getImageUrl(article.featuredImage),
            alt: article.featuredImage.alternativeText || article.title
        } : undefined}
>
    {/* âœ… ë¯¸ë¦¬ ì²˜ë¦¬ëœ processedArticleContentë¥¼ ì‚¬ìš© */}
    {processedArticleContent && processedArticleContent.map((componentData, index) => {
        const Component = components[componentData.__component];

        if (!Component) {
            console.warn(`ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${componentData.__component}`);
            return null;
        }

        if (componentData.__component === 'common.list-item' && (!componentData.items || !Array.isArray(componentData.items))) {
            console.warn(`list-itemì— itemsê°€ ì—†ìŠµë‹ˆë‹¤:`, componentData);
            return null;
        }

        // ğŸ’¡ ì—¬ê¸°ì— console.logë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”! ğŸ’¡
        // ì´ ë¶€ë¶„ì´ ì¤‘ìš”í•©ë‹ˆë‹¤. Content ì»´í¬ë„ŒíŠ¸ë¡œ ì „ë‹¬ë  ë°ì´í„°ê°€ ë¬´ì—‡ì¸ì§€ í™•ì¸í•˜ëŠ” ê³³ì…ë‹ˆë‹¤.
        if (componentData.__component === 'common.content') {
            console.log('--- Content Component Data Debugging ---');
            console.log('Component Type:', componentData.__component);
            console.log('Full Data:', componentData);
            console.log('Style property:', componentData.style); // íŠ¹íˆ ì´ ë¶€ë¶„ì„ í™•ì¸í•´ì£¼ì„¸ìš”!
            console.log('--- End Debugging ---');
        }

        return <Component key={`${componentData.__component}-${index}`} {...componentData} />;
    })}
</WebzineLayout>