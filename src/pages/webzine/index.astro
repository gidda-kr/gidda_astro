---
import BaseLayout from '../../layouts/BaseLayout.astro';

// 1. Astro 빌드 시점에 Strapi API에서 모든 웹진 기사 목록을 가져옵니다.
//    제목, 슬러그, 발행일, 작성자 정보가 필요합니다.
const strapiUrl = 'https://strapi-app-63132904920.asia-northeast3.run.app';
const apiPath = '/api/webzine-articles';

// queryParams: author 관계 필드를 populate하고, 필요한 필드만 선택적으로 가져옵니다.
const queryParams = '?populate[author][fields]=name&sort=publishedAt:desc&fields[0]=title&fields[1]=slug&fields[2]=publishedAt';

let articles = [];
try {
    const response = await fetch(`${strapiUrl}${apiPath}${queryParams}`);
    const jsonData = await response.json();
    if (jsonData.data) {
        // ✨✨✨ 이 부분을 수정했습니다! ✨✨✨
        // author 데이터가 attributes 객체 안에 있지 않고 바로 들어옵니다.
        articles = jsonData.data.map(item => {
            // item 객체에서 필요한 속성들을 바로 가져옵니다.
            const articleData = item;
            // author 객체에서 name을 바로 가져옵니다.
            const authorName = articleData.author?.name || '작성자 정보 없음';

            return {
                ...articleData,
                authorName: authorName
            };
        });
    }
} catch (error) {
    console.error('Strapi API에서 웹진 기사 목록을 가져오는 데 실패했습니다:', error);
}
---

<BaseLayout title="웹진 목록">
    <article class="webzine-list-container">
        <h1>전체 웹진 기사</h1>
        <p>총 {articles.length}개의 기사가 있습니다.</p>

        {articles.length === 0 ? (
                <p>아직 작성된 웹진 기사가 없습니다. Strapi에서 첫 번째 글을 작성해 보세요!</p>
        ) : (
                <ul class="article-list">
                    {articles.map((article) => (
                            <li class="article-card">
                                <a href={`/webzine/${article.slug}`}>
                                    <div class="article-meta">
                                        <span class="author">{article.authorName}</span>
                                        <span class="separator">•</span>
                                        <span class="date">{new Date(article.publishedAt).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                    </div>
                                    <h2>{article.title}</h2>
                                </a>
                            </li>
                    ))}
                </ul>
        )}
    </article>
</BaseLayout>

<style>
    .webzine-list-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 1rem 2rem;
    }
    .article-list {
        list-style: none;
        padding: 0;
        /* 긴 박스 형태로 정렬 */
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .article-card {
        background-color: #fcfcfc;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .article-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    .article-card a {
        text-decoration: none;
        color: inherit; /* 부모 요소의 글자색 상속 */
        display: block;
    }
    .article-card h2 {
        font-size: 1.75rem;
        line-height: 1.3;
        margin-top: 0.5rem;
        margin-bottom: 0;
    }
    .article-meta {
        font-size: 0.9rem;
        color: #888;
        margin-bottom: 0.5rem;
    }
    .article-meta .separator {
        color: #ccc;
    }
</style>