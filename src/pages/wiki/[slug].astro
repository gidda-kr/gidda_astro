---
import WikiPageLayout from '../../layouts/wiki_page.astro';
import { Remarkable } from 'remarkable';
import * as cheerio from 'cheerio'; // âœ¨ cheerio ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„í¬íŠ¸í•©ë‹ˆë‹¤.

// Remarkable ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ê°ì£¼ ê¸°ëŠ¥ì„ í™œì„±í™”í•©ë‹ˆë‹¤.
const md = new Remarkable({
  html: true,
  typographer: true,
  linkify: true,
  footnotes: true,
});

// 1. Astro ë¹Œë“œ ì‹œì ì— Strapiì—ì„œ ëª¨ë“  ìœ„í‚¤ í•­ëª©ì˜ ìŠ¬ëŸ¬ê·¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
const strapiUrl = 'https://strapi-app-63132904920.asia-northeast3.run.app';
const allWikiSlugs = new Set();
try {
  const response = await fetch(`${strapiUrl}/api/wikis?fields[0]=slug`);
  const jsonData = await response.json();
  if (jsonData.data) {
    jsonData.data.forEach(item => {
      if (item.attributes && item.attributes.slug) {
        allWikiSlugs.add(item.attributes.slug);
      } else if (item.slug) {
        allWikiSlugs.add(item.slug);
      }
    });
  }
} catch (error) {
  console.error('ëª¨ë“  ìœ„í‚¤ ìŠ¬ëŸ¬ê·¸ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
}

// 2. í˜„ì¬ í˜ì´ì§€ì˜ ìƒì„¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í˜ì´ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
export async function getStaticPaths() {
  const strapiUrlForPaths = 'https://strapi-app-63132904920.asia-northeast3.run.app/';
  const apiPath = '/api/wikis';
  try {
    const response = await fetch(`${strapiUrlForPaths}${apiPath}?fields[0]=slug`);
    if (!response.ok) {
      console.error(`getStaticPaths Strapi API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
      return [];
    }
    const jsonData = await response.json();
    const wikis = jsonData.data;
    if (!wikis || wikis.length === 0) {
      console.warn('getStaticPaths: Strapi APIì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆê±°ë‚˜, ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
      return [];
    }
    return wikis.map((wiki) => {
      const slug = (wiki.attributes && wiki.attributes.slug) ? wiki.attributes.slug : wiki.slug;
      if (!slug) {
        console.error('getStaticPaths: slug ì†ì„±ì´ ì—†ëŠ” ìœ„í‚¤ í•­ëª©:', wiki);
        return null;
      }
      return {
        params: { slug: slug },
        props: { wiki: wiki },
      };
    }).filter(Boolean);
  } catch (error) {
    console.error('getStaticPaths API í˜¸ì¶œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
    return [];
  }
}

const { wiki: rawWikiData } = Astro.props;
const strapiUrlForDetail = 'https://strapi-app-63132904920.asia-northeast3.run.app';
const currentWikiApiPath = `/api/wikis?filters[slug][$eq]=${rawWikiData.slug}&populate=*`;
let wikiEntry = null;
try {
  const response = await fetch(`${strapiUrlForDetail}${currentWikiApiPath}`);
  const jsonData = await response.json();
  if (jsonData.data && jsonData.data.length > 0) {
    wikiEntry = (jsonData.data[0].attributes) ? jsonData.data[0].attributes : jsonData.data[0];
  }
} catch (error) {
  console.error('ìœ„í‚¤ í•­ëª© ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
}

// 1. Strapiì—ì„œ ê°€ì ¸ì˜¨ ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ì„ Remarkableì„ ì‚¬ìš©í•´ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
import { markdown } from 'astro/components';
let processedMarkdownContent = wikiEntry?.content || '';
const htmlContentFromMarkdown = md.render(processedMarkdownContent);

// âœ¨âœ¨âœ¨ 2. ë³€í™˜ëœ HTMLì„ cheerioë¡œ íŒŒì‹±í•˜ê³  <a> íƒœê·¸ë¥¼ ì°¾ì•„ ìˆ˜ì •í•©ë‹ˆë‹¤. âœ¨âœ¨âœ¨
let finalHtmlContent = '';
if (htmlContentFromMarkdown) {
  const $ = cheerio.load(htmlContentFromMarkdown); // HTMLì„ ë¡œë“œí•˜ì—¬ DOMì²˜ëŸ¼ ì¡°ì‘

  // <a> íƒœê·¸ë¥¼ ëª¨ë‘ ì°¾ìŠµë‹ˆë‹¤.
  $('a').each((i, el) => {
    const href = $(el).attr('href'); // href ì†ì„± ê°€ì ¸ì˜¤ê¸°
    if (href) {
      // ğŸ’¡ ë§í¬ê°€ ê°ì£¼ ë§í¬(#fn:1)ë‚˜ ë‚´ë¶€ ì•µì»¤(#heading)ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
      if (href.startsWith('#')) {
        // ê°ì£¼ ë§í¬ëŠ” ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
        return; // ë‹¤ìŒ <a> íƒœê·¸ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
      }

      // ğŸ’¡ ë‚´ë¶€ ìœ„í‚¤ ë§í¬ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
      if (href.startsWith('/wiki/')) {
        const linkSlug = href.substring('/wiki/'.length);

        // ìŠ¬ëŸ¬ê·¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
        if (!allWikiSlugs.has(linkSlug)) {
          // ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 'red-link' í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•˜ê³  hrefë¥¼ 'í˜ì´ì§€ ìƒì„±' ë§í¬ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
          const linkText = $(el).text();
          const encodedTitle = encodeURIComponent(linkText);
          $(el).addClass('red-link').attr('href', `/create-wiki?title=${encodedTitle}`);
        }
      }
    }
  });

  // ìˆ˜ì •ëœ HTMLì„ ë‹¤ì‹œ ë¬¸ìì—´ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
  finalHtmlContent = $.html();
}
---

<WikiPageLayout title={wikiEntry?.title || 'í˜ì´ì§€ ì—†ìŒ'}>
  <article>
    {wikiEntry ? (
        <>
          <h1>{wikiEntry.title}</h1>
          {/* âœ¨ ë³€í™˜ëœ ìµœì¢… HTML ë‚´ìš©ì„ í‘œì‹œí•©ë‹ˆë‹¤. */}
          <Fragment set:html={finalHtmlContent} />
        </>
    ) : (
        <p>í•´ë‹¹ ìœ„í‚¤ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    )}
  </article>
</WikiPageLayout>

<style is:global>
  .red-link {
    color: #ff6666; /* ì‚´ì§ ì—°í•œ ë¹¨ê°• */
    text-decoration: none;
  }
  .red-link:hover {
    color: #ff3333;
    text-decoration: none;
  }
  /* BaseLayoutì—ì„œ ì„¤ì •í•œ ìŠ¤íƒ€ì¼ê³¼ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ ëª…ì‹œì ìœ¼ë¡œ ì„ íƒìë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. */
  .wiki-content-container a.red-link {
    color: #ff6666;
  }
</style>